name: "infra NS & common objects Helm Chart pipeline"

on:
  workflow_dispatch:
    inputs:
      helm_version:
        description: "Helm Version" 
        default: 3.5.4
        required: false
      repository_tenant:
        description: "Artifactory Repo Tenant Name" 
        default: mfurones01.jfrog.io
        required: false
      repository:
        description: "Artifactory Virtual Repo" 
        default: projfa01-helm
        required: false


jobs:

  build:
    name: Build & push Helm Chart to Artifactory
    
    runs-on: ubuntu-latest

    steps:

      - name: checkout front folder
        uses: Bhacaz/checkout-files@v1
        with:
          files: infrarpi/projfa01
          token: ${{ github.token }}

      - name: Install Helm 3
        run: |
          wget https://get.helm.sh/helm-v${{ github.event.inputs.helm_version }}-linux-amd64.tar.gz
          tar -xvzf helm-v${{ github.event.inputs.helm_version }}-linux-amd64.tar.gz linux-amd64/helm
          mv -f ./linux-amd64/helm ./
          rmdir ./linux-amd64
          rm -rf "helm-v${{ github.event.inputs.helm_version }}-linux-amd64.tar.gz"

      - name: Config Helm with Artifactory
        run: |
          ./helm repo add ${{ github.event.inputs.repository }} https://${{ github.event.inputs.repository_tenant }}/artifactory/${{ github.event.inputs.repository }} --username ${{ secrets.ARTIFACTORY_USER }} --password ${{ secrets.ARTIFACTORY_APIKEY }}
          ./helm repo update

      - name: Helm Package 
        run: |
          ./helm package infrarpi/projfa01 --version $GITHUB_RUN_ID --destination ./

      - uses: jfrog/setup-jfrog-cli@v1
        env:
          JF_ARTIFACTORY_1: ${{ secrets.ARTIFACTORY_TOKEN }}

      - name: Upload Package to Artifactory
        run: |
          jfrog rt u projfa01-$GITHUB_RUN_ID.tgz ${{ github.event.inputs.repository }}-dev/projfa01